# GolAnalytics

An application for soccer coaches to analyze team metrics, featuring video tagging and AI-powered play suggestions. Built with React, Supabase, and the Gemini API.

## Supabase Setup

This project requires a Supabase backend for authentication and data storage.

### 1. Create Tables

Execute the following SQL queries in your Supabase SQL Editor to create the necessary tables.

```sql
-- Create profiles table to store user roles
CREATE TABLE public.profiles (
  id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  rol text NOT NULL DEFAULT 'auxiliar',
  username text,
  avatar_url text,
  CONSTRAINT profiles_pkey PRIMARY KEY (id),
  CONSTRAINT profiles_username_key UNIQUE (username)
);
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- Create matches table
CREATE TABLE public.matches (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  torneo text NOT NULL,
  nombre_equipo text NOT NULL,
  categoria text,
  fecha date NOT NULL,
  rival text NOT NULL,
  jornada integer NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT matches_pkey PRIMARY KEY (id)
);
ALTER TABLE public.matches ENABLE ROW LEVEL SECURITY;

-- Create players table
CREATE TABLE public.players (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  nombre text NOT NULL,
  numero integer NOT NULL,
  posicion text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT players_pkey PRIMARY KEY (id)
);
ALTER TABLE public.players ENABLE ROW LEVEL SECURITY;

-- Create tags table
CREATE TABLE public.tags (
  id bigint GENERATED BY DEFAULT AS IDENTITY,
  match_id uuid NOT NULL REFERENCES public.matches(id) ON DELETE CASCADE,
  player_id uuid NOT NULL REFERENCES public.players(id) ON DELETE CASCADE,
  accion text NOT NULL,
  resultado text,
  "timestamp" real NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tags_pkey PRIMARY KEY (id)
);
ALTER TABLE public.tags ENABLE ROW LEVEL SECURITY;
```

### 2. Set Up Row Level Security (RLS)

Apply these policies to secure your data.

- **Enable RLS** for `profiles`, `matches`, `players`, and `tags` tables.
- **Profiles Table Policies:**
  - **Allow users to read their own profile:**
    - `FOR SELECT` using expression `auth.uid() = id`
  - **Allow users to update their own profile:**
    - `FOR UPDATE` using expression `auth.uid() = id`
- **Shared Data Read Access:**
  - For tables `matches`, `players`, `tags`:
  - **Allow authenticated users to read:**
    - `FOR SELECT` using expression `auth.role() = 'authenticated'`
- **Tags Table Admin-Only Write Access:**
  - **Allow 'admin' role to insert:**
    - `FOR INSERT` with check `(SELECT rol FROM public.profiles WHERE id = auth.uid()) = 'admin'::text`
  - **Allow 'admin' role to update:**
    - `FOR UPDATE` using `(SELECT rol FROM public.profiles WHERE id = auth.uid()) = 'admin'::text`
  - **Allow 'admin' role to delete:**
    - `FOR DELETE` using `(SELECT rol FROM public.profiles WHERE id = auth.uid()) = 'admin'::text`

### 3. CRITICAL: Create Profile on User Signup (Trigger)

This function and trigger automatically create a `profile` entry for a new user upon registration. This is essential for the application to work correctly.

Execute this SQL in your Supabase SQL Editor:

```sql
-- Function to create a profile for a new user
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER SET search_path = public
AS $$
BEGIN
  INSERT INTO public.profiles (id, rol)
  VALUES (new.id, 'auxiliar');
  RETURN new;
END;
$$;

-- Trigger to run the function after a new user is created in auth.users
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

```

## Environment Variables

Create a `.env.local` file in the root of your project and add your Supabase credentials. These are exposed to the client and should use the `VITE_` prefix.

```
VITE_SUPABASE_URL="YOUR_SUPABASE_URL"
VITE_SUPABASE_KEY="YOUR_SUPABASE_ANON_KEY"
VITE_API_KEY="YOUR_GEMINI_API_KEY"
```

## Vercel Deployment

When deploying to Vercel, ensure you add the same three environment variables (`VITE_SUPABASE_URL`, `VITE_SUPABASE_KEY`, `VITE_API_KEY`) in the project settings.